---
alwaysApply: true
description: 作業区切りごとのコミットとメッセージ作成のワークフローに関するルール
---

# Commit Workflow Rules

AIは開発作業において、以下のコミットワークフローを厳守すること。

1. **最小単位のコミット（原子性）**
   - 論理的に意味のある**最小の単位**（機能の実装、バグ修正、リファクタリングなど）で作業を区切り、その都度コミットを行うこと。
   - 一つのコミットには、一つの変更目的のみを含めること。

2. **コミット対象の限定（スコープ）**
   - コミットに含めるファイルは、現在指示されているタスクまたは作業区切りに**直接関連して変更されたファイルのみ**とすること。
   - **タスクに無関係なファイルや変更（インデント修正、無関係なコメントの追加・削除など）を意図的に含めないこと**。

3. **論理的な分離の徹底**
   - **機能の追加・変更**と、**コードのリファクタリング（整形、変数名変更、不要なコードの削除など）**は、**同じファイルに対する変更であっても、必ず別のコミットとして分離すること**。

4. **コミット漏れの禁止**
   - **コミットせずに次の作業ステップに進むことを固く禁ずる。**
   - 必ず作業区切りごとにコミットを完了させてから次のタスクに着手すること。
   - **ファイル作成・更新操作の後は必ず以下を実行すること**:
     - `git status`で未コミットの変更を確認
     - 未コミットの変更があれば、即座に原子的なコミットを実行
     - コマンド実行（`/kiro/spec-*`等）、ファイル作成・更新、コード変更のいずれの操作後も同様
     - この確認とコミットは、次の作業に進む前、または会話を終了する前に必ず実行すること

5. **コミットメッセージのフォーマットと言語**
   - 基本的に、既存のプロジェクトの `git log` のフォーマット（Prefixや記述スタイル）と言語に合わせること。
   - ただし、既存のログが一貫性に欠ける、または不明瞭な場合に限り、可読性を高めるための明らかな改善（例：Conventional Commitsへの準拠など）は許可する。

6. **破壊的操作の禁止**
   - **`git reset --hard`は絶対禁止**: 作業ディレクトリの変更も削除する破壊的操作のため、ユーザーの明示的な指示がない限り使用しないこと。
   - コミットの修正が必要な場合は、`git reset --soft`（ステージング状態を保持）または`git reset --mixed`（作業ディレクトリの変更を保持）を使用すること。
   - **`git commit --amend`は避ける**: 履歴を書き換える操作のため、既存ルールに従い`git reset --soft`を使用して複数コミットをまとめる方法を優先すること。
   - コミットの修正や取り消しが必要な場合は、作業ディレクトリの変更を保護する方法を選択すること。

7. **ユーザー意図の確認**
   - ファイルの関連性やコミット対象が不明確な場合は、ユーザーに確認を求めること。
   - ユーザーの意図を推測せず、不明確な点は質問すること。
   - 破壊的操作を実行する前に、必ずユーザーの明示的な許可を得ること。

8. **サブモジュールの更新ワークフロー**
   - **サブモジュール側のルールを更新した場合**:
     1. サブモジュールディレクトリ（例: `.cursor/rules`）内で変更をコミット
     2. サブモジュール側のリポジトリにプッシュ（必要に応じて）
     3. **メイン側でサブモジュールの参照を更新**: `git add .cursor/rules && git commit` でサブモジュールの新しいコミット参照を記録
   - **2つのコミットに分離**:
     - サブモジュール側のコミット: ルールファイルの変更内容
     - メイン側のコミット: サブモジュール参照の更新（`chore: .cursor/rulesサブモジュール参照を更新`など）
   - サブモジュール側の変更とメイン側の参照更新は**必ず別のコミット**として分離すること
   - **`git submodule update`の使い分け**:
     - `git submodule update`: メインリポジトリに記録されている既存のサブモジュール参照に作業ディレクトリを合わせる（既存参照に「戻す」操作）
     - `git submodule update --remote`: サブモジュールのリモートから最新コミットを取得して更新（他の人が更新した場合に使用）
     - `git add .cursor/rules && git commit`: サブモジュール側でローカルでコミットした新しい参照をメインリポジトリに記録（今回のケースで使用）